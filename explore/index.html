---
layout: default
title: About CrisisNET
---
<style>
#suggest-list {
  margin-top: 5px;
  background: #eee;
  list-style: none;
  padding-left: 0px;
}

#suggest-list li {
  padding: 10px;
  border-bottom: 1px solid #ccc;
  font-size: 14px;
}

#suggest-list li:hover {
  background: #fff;
  cursor: pointer;
}
</style>

<div class="header-wrap header-wrap-short"><div class="header">
{% include nav.html %}
</div></div>

<div class="row content text-content">
  <div class="col-md-9">
    <h2>Explore the API</h2>
    <p>The CrisisNET platform is capable of housing any incident data and making it accessible in a simple, standard format for your project. Use the filters on the right to navigate our sample data.</p>
  </div>
</div>

<div class="row content text-content">
  <div class="col-md-9">
    <div class="input-group">
      <span class="input-group-addon">http://devapi.crisis.net/item</span>
      <input id="query-params" type="text" class="form-control" placeholder="Query params">
    </div>

    <pre style="overflow-y:auto;height:300px;margin-top:10px;" id="api-response"></pre>
    <div id="map-canvas" style="height:400px;margin-top:20px;"></div>
  </div>

  <div class="col-md-3">
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">Filter Results</h3>
      </div>
      <div class="panel-body">
        <form role="form">
          <div class="form-group">
            <label for="location">Location</label>
            <input type="text" class="form-control" id="location" placeholder="Enter location">
            <ul id="suggest-list"></ul>
          </div>

          <strong>Tags</strong>
          <div class="checkbox">
            <label>
              <input data-type="tags" value="physical-violence" type="checkbox"> physical-violence
            </label>
          </div>
          <div class="checkbox">
            <label>
              <input data-type="tags" value="armed-conflict" type="checkbox"> armed-conflict
            </label>
          </div>
          <div class="checkbox">
            <label>
              <input data-type="tags" value="flood" type="checkbox"> flood
            </label>
          </div>
          <div class="checkbox">
            <label>
              <input data-type="tags" value="tropical-cyclone" type="checkbox"> tropical-cyclone
            </label>
          </div>
          <div class="checkbox">
            <label>
              <input data-type="tags" value="earthquake" type="checkbox"> earthquake
            </label>
          </div>

          <hr>

          <strong>Sources</strong>
          <div class="checkbox">
            <label>
              <input data-type="sources" value="ushahidi" type="checkbox"> Ushahidi
            </label>
          </div>
          <div class="checkbox">
            <label>
              <input data-type="sources" value="gdelt" type="checkbox"> GDELT
            </label>
          </div>
          <div class="checkbox">
            <label>
              <input data-type="sources" value="reliefweb" type="checkbox"> ReliefWeb
            </label>
          </div>
        </form> 
      </div>
    </div>
  </div>
</div>

<script src="//maps.googleapis.com/maps/api/js?sensor=false"></script>
<script src="/scripts/markercluster.js"></script>
<script>
window.doOnLoad = function() {
  var mapOptions = {
      center: new google.maps.LatLng(34.30714385628804, -41.484375),
      zoom: 2,
      mapTypeId: google.maps.MapTypeId.ROADMAP,
      disableDefaultUI:true,
      streetViewControl: false,
      draggable: true,
      navigationControl: true,
      scalControl: false,
      panControl: false,
      zoomControl: true,
      scaleControl: true,
      scrollwheel: false
    };

  var streetMap = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
  var markerCluster = new MarkerClusterer(streetMap, []);

  var clearMarkers = function() {
    _(markers).each(function(marker) {
      marker.setMap(null);
    })
  };

  var updateMap = function(data) {
    markerCluster.clearMarkers();

    $.each(data, function(idx, val) {
      var coords = val.geo.coords;
      var latLng = new google.maps.LatLng(coords[1], coords[0]);
      var marker = new google.maps.Marker({
          position: latLng,
          map: streetMap,
          title: val.summary
      });

      var infowindow = new google.maps.InfoWindow({
          content: val.content
      });

      google.maps.event.addListener(marker, 'click', function() {
        infowindow.open(streetMap,marker);
      });

      markerCluster.addMarker(marker);
    }); 
  };

  var pingAPI = function(url) {
    console.log("Requesting: " + url);
    $.ajax({
      url: url,
      dataType: "json",
      beforeSend: function(xhr) {
        xhr.setRequestHeader('Authorization', 'Bearer 532d32c7ed3329652f114b70');
      },
      success: function (data) {
        $('#api-response').html(JSON.stringify(data, undefined, 2));
        updateMap(data.data);
      }
    });
  };

  var baseAPIURL = 'http://devapi.crisis.net/item';

  pingAPI(baseAPIURL);

  var queryParams = {};
  var addQueryParam = function(param, value) {
    if(queryParams[param]) {
      var vals = queryParams[param].split(',');
      if(!_(vals).contains(value)) {
        vals.push(value);
      }
      queryParams[param] = vals.join(',');
    }
    else {
      queryParams[param] = value;
    }
  };

  var removeQueryParam = function(param, value) {
    var vals = queryParams[param].split(',');
    vals = _(vals).without(value);

    if(_(vals).isEmpty()) {
      delete queryParams[param];
    }
    else {
      queryParams[param] = vals.join(',');
    }
  };

  var makeParams = function() {
    var params = $.param(queryParams);
    var paramString = '';

    if(params.length > 0) {
      paramString = '?' + params;
    }

    $('#query-params').val(paramString);

    return paramString;
  };

  // Checkboxes
  var handleCheckboxClick = function(e) {
    var $this = $(e.target);

    if($this.is(':checked')) {
      addQueryParam($this.data('type'), $this.val());
    }
    else {
      removeQueryParam($this.data('type'), $this.val());
    }

    var paramString = makeParams();
    pingAPI(baseAPIURL+paramString);
  };


  // Location
  var chooseSuggestValue = function(e) {
    var text = $(e.target).text();
    $('#location').val(text);
    $('#suggest-list').find('li').remove();

    $.getJSON('https://maps.googleapis.com/maps/api/geocode/json?address='+text+'&sensor=false', function(data) {
        if(data.status === "OK") {
          var coords = data.results[0].geometry.location;
          updateLocation(coords);
        }
        else {
          alert("We could not geocode that address");
        }
    });
  };

  var updateLocation = function(coords) {
    queryParams.location = coords.lng + "," + coords.lat;

    var paramString = makeParams();
    pingAPI(baseAPIURL+paramString);

    streetMap.setZoom(8);
    var latLng = new google.maps.LatLng(coords.lat, coords.lng);
    streetMap.setCenter(latLng);
  };
  
  var suggestFromGoogle = function() {
    $.getJSON('http://www.google.com/maps/suggest?callback=?&q='+$(this).val(),function(data) {
      var $container = $('#suggest-list');
      $container.find('li').remove();
      $.each(data.suggestion,function() {
        $container.append('<li>'+this.query+'</li>');
      });
    });
  };

  google.maps.event.addListener(streetMap, "click", function (e) {
    //lat and lng is available in e object
    var latLng = e.latLng;
    console.log(latLng);
    updateLocation({lng:latLng.A, lat:latLng.k});
  });


  // binding
  $('input[type=checkbox]').click(handleCheckboxClick);
  $('#location').keyup(suggestFromGoogle);
  $('#suggest-list').on("click", "li", chooseSuggestValue);
};
</script>